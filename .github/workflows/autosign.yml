# 98tang Auto Sign-in
name: 98tang Auto Sign-in

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 06:40ï¼ˆUTC 22:40ï¼‰
    - cron: '40 22 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  autosign:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: 98tang-autosign

    env:
      # chromedriver ç‰ˆæœ¬
      UDC_CHROMEDRIVER_VERSION: "142"

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–å’Œä¸­æ–‡å­—ä½“
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra language-pack-zh-hans
        sudo fc-cache -fv

    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´
      run: |
        echo "â° UTC æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸŒ åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

    - name: æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ°
      env:
        PYTHONUNBUFFERED: 1

        # ===== æ ¸å¿ƒè´¦å·é…ç½® =====
        SITE_USERNAME: ${{ secrets.SITE_USERNAME }}
        SITE_PASSWORD: ${{ secrets.SITE_PASSWORD }}

        # â˜…â˜…â˜…â˜…â˜… å…³é”®ä¿®å¤ç‚¹ï¼šCookie æ³¨å…¥ â˜…â˜…â˜…â˜…â˜…
        SITE_COOKIES: ${{ secrets.SITE_COOKIES }}
        # â˜…â˜…â˜…â˜…â˜… END â˜…â˜…â˜…â˜…â˜…

        # ===== å®‰å…¨æé—® =====
        ENABLE_SECURITY_QUESTION: ${{ vars.ENABLE_SECURITY_QUESTION || 'false' }}
        SECURITY_QUESTION: ${{ secrets.SECURITY_QUESTION }}
        SECURITY_ANSWER: ${{ secrets.SECURITY_ANSWER }}

        # ===== åŸºç¡€é…ç½® =====
        BASE_URL: ${{ vars.BASE_URL || 'https://www.sehuatang.org' }}
        ENABLE_CHECKIN: ${{ vars.ENABLE_CHECKIN || 'true' }}

        # ===== æ‹ŸäººåŒ–é…ç½® =====
        ENABLE_REPLY: ${{ vars.ENABLE_REPLY || 'true' }}
        REPLY_COUNT: ${{ vars.REPLY_COUNT || '2' }}
        ENABLE_RANDOM_BROWSING: ${{ vars.ENABLE_RANDOM_BROWSING || 'true' }}
        BROWSE_PAGE_COUNT: ${{ vars.BROWSE_PAGE_COUNT || '3' }}
        COMMENT_INTERVAL: ${{ vars.COMMENT_INTERVAL || '15' }}
        WAIT_AFTER_LOGIN: ${{ vars.WAIT_AFTER_LOGIN || '5' }}
        REPLY_MESSAGES: ${{ vars.REPLY_MESSAGES || 'æ„Ÿè°¢åˆ†äº«èµ„æºï¼Œæ”¶è—äº†;å¥½èµ„æºæ”¶è—äº†ï¼Œè°¢è°¢æ¥¼ä¸»' }}

        # ===== å»¶è¿Ÿé…ç½® =====
        TIMING_MULTIPLIER: ${{ vars.TIMING_MULTIPLIER || '1.0' }}
        ENABLE_SMART_TIMING: ${{ vars.ENABLE_SMART_TIMING || 'true' }}

        # ===== Telegram =====
        ENABLE_TELEGRAM_NOTIFICATION: ${{ vars.ENABLE_TELEGRAM_NOTIFICATION || 'false' }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_PROXY_URL: ${{ secrets.TELEGRAM_PROXY_URL }}
        TELEGRAM_SEND_LOG_FILE: ${{ vars.TELEGRAM_SEND_LOG_FILE || 'true' }}
        TELEGRAM_SEND_SCREENSHOT: ${{ vars.TELEGRAM_SEND_SCREENSHOT || 'false' }}

        # ===== ç³»ç»Ÿ =====
        HEADLESS: 'true'
        LOG_LEVEL: ${{ vars.LOG_LEVEL || 'DEBUG' }}
        MAX_LOG_FILES: ${{ vars.MAX_LOG_FILES || '7' }}
        MAX_RETRIES: ${{ vars.MAX_RETRIES || '3' }}
        TIMEOUT_MINUTES: ${{ vars.TIMEOUT_MINUTES || '5' }}

        # ===== ä¸­æ–‡ç¯å¢ƒ =====
        LANG: zh_CN.UTF-8
        LC_ALL: zh_CN.UTF-8
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: '1'

      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ°..."
        python main.py

    - name: ä¸Šä¼ æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: autosign-logs-${{ github.run_number }}
        path: logs/
        retention-days: 30
