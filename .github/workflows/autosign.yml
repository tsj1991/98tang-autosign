# 98tang Auto Sign-in
# å®Œæ•´é…ç½®è¯´æ˜è¯·å‚è€ƒ: docs/configuration.md
name: 98tang Auto Sign-in

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´0:00æ‰§è¡Œ (UTC+8 = UTC+0-8, æ‰€ä»¥0ç‚¹å¯¹åº”UTC 16ç‚¹)
    - cron: '40 22 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Environment secretsæ¨¡å¼ï¼ˆä¼˜å…ˆï¼‰- ä½¿ç”¨98tang-autosignç¯å¢ƒ
  autosign-environment:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: 98tang-autosign
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    # â˜…â˜…â˜…â˜…â˜… å…³é”®ä¿®å¤ç‚¹ï¼šè¿™é‡Œè®¾ç½®å…¨å±€ç¯å¢ƒå˜é‡ â˜…â˜…â˜…â˜…â˜…
    env:
      UDC_CHROMEDRIVER_VERSION: "142"
    # â˜…â˜…â˜…â˜…â˜… END â˜…â˜…â˜…â˜…â˜…

    outputs:
      failure_reason: ${{ steps.check_config.outputs.failure_reason }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–å’Œä¸­æ–‡å­—ä½“
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra language-pack-zh-hans
        sudo fc-cache -fv
        echo "âœ… å·²å®‰è£…çš„ä¸­æ–‡å­—ä½“:"
        fc-list :lang=zh | head -5
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: éªŒè¯å¿…éœ€é…ç½®
      id: check_config
      run: |
        if [ -z "${{ secrets.SITE_USERNAME }}" ] || [ -z "${{ secrets.SITE_PASSWORD }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…éœ€çš„ Environment Secrets é…ç½®"
          echo "failure_reason=missing_environment_secrets" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "âœ… é…ç½®éªŒè¯é€šè¿‡ (Environment secretsæ¨¡å¼: 98tang-autosign)"
        
    - name: æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´
      run: |
        echo "â° å½“å‰UTCæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸŒ åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        
    - name: æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ°
      env:
        PYTHONUNBUFFERED: 1

        # å¿…éœ€é…ç½®
        SITE_USERNAME: ${{ secrets.SITE_USERNAME }}
        SITE_PASSWORD: ${{ secrets.SITE_PASSWORD }}
        
        # å®‰å…¨æé—®é…ç½®
        ENABLE_SECURITY_QUESTION: ${{ vars.ENABLE_SECURITY_QUESTION || 'false' }}
        SECURITY_QUESTION: ${{ secrets.SECURITY_QUESTION }}
        SECURITY_ANSWER: ${{ secrets.SECURITY_ANSWER }}
        
        # æ ¸å¿ƒåŠŸèƒ½é…ç½®
        BASE_URL: ${{ vars.BASE_URL || 'https://www.sehuatang.org' }}
        ENABLE_CHECKIN: ${{ vars.ENABLE_CHECKIN || 'true' }}
        
        # æ‹ŸäººåŒ–è¡Œä¸ºé…ç½®
        ENABLE_REPLY: ${{ vars.ENABLE_REPLY || 'true' }}
        REPLY_COUNT: ${{ vars.REPLY_COUNT || '2' }}
        ENABLE_RANDOM_BROWSING: ${{ vars.ENABLE_RANDOM_BROWSING || 'true' }}
        BROWSE_PAGE_COUNT: ${{ vars.BROWSE_PAGE_COUNT || '3' }}
        COMMENT_INTERVAL: ${{ vars.COMMENT_INTERVAL || '15' }}
        WAIT_AFTER_LOGIN: ${{ vars.WAIT_AFTER_LOGIN || '5' }}
        REPLY_MESSAGES: ${{ vars.REPLY_MESSAGES || 'æ„Ÿè°¢åˆ†äº«èµ„æºï¼Œæ”¶è—äº†;å¥½èµ„æºæ”¶è—äº†ï¼Œè°¢è°¢æ¥¼ä¸»;æ„Ÿè°¢æ¥¼ä¸»çš„ç²¾å½©åˆ†äº«;è°¢è°¢åˆ†äº«ï¼Œæ„Ÿè°¢ç²¾å½©èµ„æº;å¥½å†…å®¹ï¼Œæ”¯æŒä¸€ä¸‹æ¥¼ä¸»' }}
        
        # å»¶è¿Ÿä¼˜åŒ–é…ç½®
        TIMING_MULTIPLIER: ${{ vars.TIMING_MULTIPLIER || '1.0' }}
        ENABLE_SMART_TIMING: ${{ vars.ENABLE_SMART_TIMING || 'true' }}
        
        # Telegramé€šçŸ¥é…ç½®
        ENABLE_TELEGRAM_NOTIFICATION: ${{ vars.ENABLE_TELEGRAM_NOTIFICATION || 'false' }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_PROXY_URL: ${{ secrets.TELEGRAM_PROXY_URL }}
        TELEGRAM_SEND_LOG_FILE: ${{ vars.TELEGRAM_SEND_LOG_FILE || 'true' }}
        TELEGRAM_SEND_SCREENSHOT: ${{ vars.TELEGRAM_SEND_SCREENSHOT || 'false' }}
        
        # ç³»ç»Ÿé…ç½®
        HEADLESS: 'true'
        LOG_LEVEL: ${{ vars.LOG_LEVEL || 'DEBUG' }}
        MAX_LOG_FILES: ${{ vars.MAX_LOG_FILES || '7' }}
        MAX_RETRIES: ${{ vars.MAX_RETRIES || '3' }}
        TIMEOUT_MINUTES: ${{ vars.TIMEOUT_MINUTES || '5' }}

        # ä¸­æ–‡ç¯å¢ƒ
        LANG: 'zh_CN.UTF-8'
        LC_ALL: 'zh_CN.UTF-8'
        PYTHONIOENCODING: 'utf-8'
        PYTHONUTF8: '1'
        
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ°..."
        python main.py
        
    - name: ä¸Šä¼ æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: autosign-logs-environment-${{ github.run_number }}
        path: logs/
        retention-days: 30
        
    - name: æ‰§è¡Œç»“æœé€šçŸ¥
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "âœ… è‡ªåŠ¨ç­¾åˆ°æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ è‡ªåŠ¨ç­¾åˆ°æ‰§è¡Œå¤±è´¥"
        fi

  # Repository secretsæ¨¡å¼ï¼ˆæ™ºèƒ½å›é€€ï¼‰
  autosign-repository:
    if: failure() && needs.autosign-environment.result == 'failure' && needs.autosign-environment.outputs.failure_reason == 'missing_environment_secrets' && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    needs: autosign-environment
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # â˜…â˜…â˜…â˜…â˜… å›é€€æ¨¡å¼ä¹Ÿå¿…é¡»è®¾ç½® â˜…â˜…â˜…â˜…â˜…
    env:
      UDC_CHROMEDRIVER_VERSION: "142"
    # â˜…â˜…â˜…â˜…â˜… END â˜…â˜…â˜…â˜…â˜…

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–å’Œä¸­æ–‡å­—ä½“
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra language-pack-zh-hans
        sudo fc-cache -fv
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: éªŒè¯å¿…éœ€é…ç½®
      run: |
        if [ -z "${{ secrets.SITE_USERNAME }}" ] || [ -z "${{ secrets.SITE_PASSWORD }}" ]; then
          echo "âŒ Repository Secrets ä¸å®Œæ•´"
          exit 1
        fi
        echo "âœ… é…ç½®éªŒè¯é€šè¿‡ (Repository secretsæ¨¡å¼)"
        
    - name: æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ°
      env:
        # å¿…éœ€é…ç½®
        SITE_USERNAME: ${{ secrets.SITE_USERNAME }}
        SITE_PASSWORD: ${{ secrets.SITE_PASSWORD }}
        
        # å…¶ä½™é…ç½®å®Œå…¨å¤åˆ¶ï¼ˆç•¥ï¼Œä¸ä¸Šæ–¹ä¸€è‡´ï¼‰
        
        HEADLESS: 'true'
        
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ° (å›é€€æ¨¡å¼)"
        python main.py
        
    - name: ä¸Šä¼ æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: autosign-logs-repository-${{ github.run_number }}
        path: logs/
        retention-days: 30
